@page "/order-detail/{OrderId:int}"
@inject IOrderService OrderService
@inject IUserContextService UserContextService
@inject ICartService CartService
@inject IToastCloneService ToastService
@inject NavigationManager NavigationManager

@if (orderViewModel != null)
{
    <div class="mb-20">
        <div class="flex items-center gap-4 mb-4 mt-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Chi tiết đơn hàng</h1>
                <p class="text-sm text-gray-500">
                    Đơn hàng #@OrderId đặt ngày @orderViewModel.OrderDate.ToString("dd/MM/yyyy")
                </p>
            </div>

            <span class="@GetBadgeClasses(orderViewModel.Status)">
                @GetStatusDisplayName(orderViewModel.Status)
            </span>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Column: Order Items -->
            <div class="w-full lg:w-2/3">
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Số lượng sản phẩm (@orderViewModel.OrderItems.Count)</h2>
                    <div class="overflow-y-auto h-[30rem]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên sản phẩm</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số lượng</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giá</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                @foreach (var item in orderViewModel.OrderItems)
                                {
                                    <OrderDetailsItem Item="item" />
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary & Customer Info -->
            <div class="w-full lg:w-1/3 flex flex-col gap-4">
                <!-- Order Summary -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-4">Thông tin đơn hàng</h3>
                    <div class="space-y-3 text-gray-600">
                        <div class="flex justify-between">
                            <span>Tổng giá</span>
                            <span class="font-medium text-gray-900">@orderViewModel.TotalAmount.ToString("C")</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Khuyến mãi</span>
                            <span class="font-medium text-gray-900">@orderViewModel.DiscountAmount.ToString("C")</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg text-gray-900 border-t pt-3">
                            <span>Thành tiền</span>
                            <span>@((orderViewModel.TotalAmount - orderViewModel.DiscountAmount).ToVnd())</span>
                        </div>
                    </div>
                </div>

                @if(@orderViewModel.Status.ToLower() == "pending")
                {
                    <button class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow-sm transition"
                            @onclick="PaymentEvent">
                        Thanh toán @((orderViewModel.TotalAmount - orderViewModel.DiscountAmount).ToVnd())
                    </button>
                }

                <!-- Customer Information -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-4">Customer Information</h3>
                    <div class="space-y-3 text-gray-600">
                        <p><strong class="font-medium text-gray-800">Name:</strong> @customer.Name</p>
                        <p><strong class="font-medium text-gray-800">Phone:</strong> @customer.Phone</p>
                        <p><strong class="font-medium text-gray-800">Email:</strong> @customer.Email</p>
                        <p><strong class="font-medium text-gray-800">Address:</strong> @customer.Address</p>
                    </div>
                </div>
            </div>
        </div>

        <NavLink href="/orders" class="mt-4 inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-white hover:bg-green-700">
            Danh sách đơn hàng
        </NavLink>
    </div>
}
else
{
    <p class="text-center text-gray-500">Loading order details...</p>
}


@code {
    [Parameter]
    public int OrderId { get; set; }

    private OrderViewModel? orderViewModel;
    private CustomerModel? customer;

    protected override void OnInitialized()
    {

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            var response = await OrderService.GetOrderByIdAsync(OrderId);
            if(response.StatusCode == 200)
            {
                orderViewModel = response.Content;
            }
            try
            {
                var customerResponse = await UserContextService.GetCurrentCustomerAsync();
                if(customerResponse != null)
                {
                    customer = customerResponse;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching customer info: {ex.Message}");
            }
            finally
            {
                StateHasChanged();
            }
        }
    }

    public async Task PaymentEvent()
    {
        VnpayPaymentRequest paymentRequest = new VnpayPaymentRequest
        {
            Money = (double) (orderViewModel.TotalAmount - orderViewModel.DiscountAmount),
            Description = $"Thanh toan don hang #{orderViewModel.OrderId} tai DotNet Store",
            BankCode = VNPAY.Models.Enums.BankCode.ANY,
            Language = VNPAY.Models.Enums.DisplayLanguage.Vietnamese
        };

        APIResponse<CheckoutResponse> response =
            await OrderService.RepayOrderAsync<APIResponse<CheckoutResponse>>(OrderId);

        if (response != null && response.StatusCode == 200)
        {
            NavigationManager.NavigateTo(response.Content.PaymentUrl);
            await CartService.ClearCartAsync();
        }
        else
        {
            ToastService.ShowToast("Đã có lỗi xảy ra trong quá trình thanh toán!", ToastLevel.Error);
        }
    }
    
    private string GetBadgeClasses(string status)
    {
        var baseClass = "px-4 py-1.5 rounded-full text-sm font-semibold border shadow-sm";

        return status.ToLower() switch
        {
            "paid" => $"{baseClass} bg-green-50 text-green-700 border-green-200",
            "pending" => $"{baseClass} bg-orange-50 text-orange-700 border-orange-200", // Màu cam cho chưa thanh toán
            "canceled" => $"{baseClass} bg-red-50 text-red-700 border-red-200",
            _ => $"{baseClass} bg-gray-50 text-gray-700 border-gray-200"
        };
    }

    private string GetStatusDisplayName(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "Chưa thanh toán",
            "paid" => "Đã thanh toán",
            "canceled" => "Đã hủy",
            _ => status
        };
    }

}
