@page "/checkout-validate"
@using System.Threading.Tasks
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient

@code{
    [SupplyParameterFromQuery(Name = "vnp_ResponseCode")]
    public string? VnpResponseCode { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var queryString = uri.Query;

        try
        {
            var response = await HttpClient.GetFromJsonAsync<PaymentResultDto>($"api/v1/order/checkout/proceedAfterPayment{queryString}");

            if(response.Content != null)
            {
                NavigationManager.NavigateTo($"/checkout-success?responseCode=00");
            }
            else
            {
                NavigationManager.NavigateTo($"/checkout-failure?responseCode=24");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error calling payment API: {ex.Message}");
            NavigationManager.NavigateTo("/checkout-failure?responseCode=Exception");
        }
    }

    public class PaymentResultDto
    {
        public VnpayPaymentResult? Content { get; set; }
        public int StatusCode { get; set; }
        public string? Message { get; set; }
    }
}