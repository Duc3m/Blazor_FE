@page "/admin/categories"
@using System.ComponentModel.DataAnnotations
@using Blazor_FE.Services.Base
@using Blazorise.DataGrid
@using Blazor_FE.Components.Pages.Admin.Products
@using Blazor_FE.Services.Categories.dtos
@inject ICategoryService CategoryService
@inject IToastCloneService ToastService
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "admin")]

<div>
    @if (categories == null)
    {
    <SkeletonTable Rows="5" Columns="4" />
    }
    else
    {
        <div class="flex gap-2 mb-4 items-center">
            <button
                class="rounded bg-blue-500 px-4 py-2 text-white hover:bg-blue-600 whitespace-nowrap"
                @onclick="@(() => OpenModal("ADD"))">
                Thêm danh mục
            </button>
            <div class="relative">
                <input
                    @bind="searchQuery.CategoryName"
                    class="border rounded px-3 py-1.5 w-64"
                    placeholder="Tìm kiếm danh mục..."/>
            </div>
            <button
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded whitespace-nowrap"
                @onclick="@(() => handleSearch())">
                Search
            </button>
        </div>
        <DataGrid TItem="CategoryModel"
                  Data="@(categories?.Content ?? new())"
                  Hoverable
                  Responsive>

            <DataGridColumns>
                <DataGridColumn TItem="CategoryModel" Field="@nameof(CategoryModel.CategoryId)" Caption="ID" Width="100px" />
                <DataGridColumn TItem="CategoryModel" Field="@nameof(CategoryModel.CategoryName)" Caption="Tên danh mục" />
                <DataGridColumn Caption="Actions">
                    <DisplayTemplate Context="context">
                        <div class="flex gap-2">
                            <button
                                class="rounded bg-blue-500 px-4 py-2 text-white hover:bg-blue-600"
                                @onclick:preventDefault
                                @onclick="@(() => OpenModal("EDIT", context))">
                                Sửa
                            </button>
                            <button
                                class="rounded bg-red-500 px-4 py-2 text-white hover:bg-red-600"
                                @onclick="@(() => OpenModal("DELETE", context))"
                                @onclick:preventDefault>
                                Xoá
                            </button>
                        </div>
                    </DisplayTemplate>
                </DataGridColumn>
            </DataGridColumns>
        </DataGrid>
        @* FORM *@
        <Modal @ref="@modal">
            <ModalContent Size="ModalSize.Default" Class="p-4 max-h-[90vh] overflow-y-auto">
                <div class="header-modal">
                    <CloseButton @onclick="@(() => CloseModal())" />
                    <ModalTitle>@(selectedType switch
                                {
                                    "EDIT" => "Chỉnh sửa danh mục",
                                    "ADD" => "Thêm mới danh mục",
                                    _ => "Danh mục"
                                })
                    </ModalTitle>
                </div>
                <EditForm EditContext="@editContext" OnValidSubmit="@(selectedType switch
                                                                    {
                                                                        "EDIT" => handleEdit,
                                                                        "ADD" => handleAdd,
                                                                        _ => handleAdd
                                                                    })">
                    <DataAnnotationsValidator></DataAnnotationsValidator>
                    <Field>
                        <FieldLabel>Tên danh mục</FieldLabel>
                        <InputText
                            Class="custom-input"
                            @bind-Value="category.CategoryName"
                            placeholder="Tên danh mục..."/>
                        <ValidationMessage For="@(() => category.CategoryName)" class="text-red-500 text-sm" />
                    </Field>
                    <Footer class="flex justify-end space-x-2 p-4">
                        <button
                            type="submit"
                            class="rounded bg-blue-500 px-4 py-2 text-white hover:bg-blue-600"
                        >
                            Lưu
                        </button>
                        <button
                            class="rounded bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300"
                            @onclick="@(() => CloseModal())"
                            @onclick:preventDefault>
                            Hủy
                        </button>
                    </Footer>
                </EditForm>
            </ModalContent>
        </Modal>
        @* DELETE MODAL *@
        <Modal @ref="@deleteConfirmModal">
            <ModalContent>
                <ModalHeader>
                    <ModalTitle>Xác nhận xóa</ModalTitle>
                    <CloseButton @onclick="@(() => deleteConfirmModal.Hide())" />
                </ModalHeader>
                <ModalBody>
                    Bạn có chắc chắn muốn xóa danh mục này không?
                </ModalBody>
                <ModalFooter>
                    <button
                        class="rounded bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300"
                        @onclick="@(() => CloseModal("DELETE"))"
                        @onclick:preventDefault>
                        Thoát
                    </button>
                    <button
                        class="rounded bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300"
                        @onclick="@(() => handleDelete())"
                        @onclick:preventDefault>
                        Xóa
                    </button>
                </ModalFooter>
            </ModalContent>
        </Modal>
        <CustomPagination
            CurrentPage="@currentPage"
            TotalPages="@totalPages"
            OnPageChanged="OnPageChanged"
        />
    }
</div>

<style>
    .custom-input {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        width: 100%;
        transition: border-color 0.15s ease-in-out;
    }

    .custom-input:focus {
        border-color: transparent;
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        transition: box-shadow 0.2s ease-in-out;
    }

    .selected-row-style {
        background-color: #9fc4f8 !important;
        font-weight: bold !important;
    }
</style>

@code {
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages;
    
    private SearchCategoryDTO searchQuery = new();


    private string selectedType;
    private EditContext editContext;
    
    private APIResponse<List<CategoryModel>>? categories;
    private CategoryDTO category = new();

    private Modal modal, deleteConfirmModal;

    protected override async Task OnInitializedAsync()
    {
        @* RELOAD PARAMS *@
        var uri = new Uri(NavigationManager.Uri);
        var baseUri = uri.GetLeftPart(UriPartial.Path);
        if (!string.IsNullOrEmpty(uri.Query))
        {
            NavigationManager.NavigateTo(baseUri, replace: true);
        }
        
        editContext = new EditContext(category);
        await LoadCategories(1);
    }

    private async Task LoadCategories(int page)
    {
        searchQuery.PageNumber = page;
        searchQuery.PageSize = pageSize;
        categories = await CategoryService.SearchAsync<CategoryModel>(searchQuery);
        totalPages = categories.Metadata.TotalPages;
        StateHasChanged();
    }

    private void OpenModal(string type, CategoryModel context = null!)
    {
        selectedType = type;
        switch (type)
        {
            case "ADD":
                category = new CategoryDTO();
                editContext = new EditContext(category);
                modal.Show();
                break;
            case "EDIT":
                category = new CategoryDTO
                {
                    CategoryId = context.CategoryId,
                    CategoryName = context.CategoryName
                };
                editContext = new EditContext(category);
                modal.Show();
                break;
            case "DELETE":
                category = new CategoryDTO
                {
                    CategoryId = context.CategoryId,
                    CategoryName = context.CategoryName
                };
                deleteConfirmModal.Show();
                break;
        }
        Console.WriteLine(type);
    }

    private void CloseModal(string type = "")
    {
        switch (type)
        {
            case "":
                modal.Hide();
                break;
            case "DELETE":
                deleteConfirmModal.Hide();
                break;
        }
    }
    
    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadCategories(currentPage);
    }
    
    @**@
    private async Task handleSearch()
    {
        var uri = new Uri(NavigationManager.Uri);
        var baseUri = uri.GetLeftPart(UriPartial.Path);

        var parameters = new Dictionary<string, object?>();
        
        if (!string.IsNullOrWhiteSpace(searchQuery.CategoryName))
        {
            parameters["categoryName"] = searchQuery.CategoryName;
        }
        
        var url = NavigationManager.GetUriWithQueryParameters(baseUri, parameters);
        NavigationManager.NavigateTo(url, replace: true);
        
        currentPage = 1;
        await LoadCategories(currentPage);
    }
    
    @* HANDLE CRUD *@
    private async Task handleAdd()
    {
        try
        {
            var response = await CategoryService.AddAsync(category);
            
            if (response.StatusCode != 200)
            {
                ToastService.ShowToast(response.Message, ToastLevel.Error);
                return;
            }
            
            ToastService.ShowToast(response.Message);
            
            category = new();
            await modal.Hide();
            currentPage = 1;
            await LoadCategories(currentPage);
        }
        catch (Exception ex)
        {
            throw new Exception(ex.Message);
        }
    }
    
    private async Task handleEdit()
    {
        try
        {
            var response = await CategoryService.EditAsync(category.CategoryId, category);
            
            if (response.StatusCode != 200)
            {
                ToastService.ShowToast(response.Message, ToastLevel.Error);
                return;
            }
            
            ToastService.ShowToast(response.Message);
            
            category = new();
            await modal.Hide();
            currentPage = 1;
            await LoadCategories(currentPage);
        }
        catch (Exception ex)
        {
            throw new Exception(ex.Message);
        }
    }
    
    private async Task handleDelete()
    {
        try
        {
            var response = await CategoryService.DeleteAsync<CategoryModel>(category.CategoryId);
            
            if (response.StatusCode != 200)
            {
                ToastService.ShowToast(response.Message, ToastLevel.Error);
                return;
            }
            
            ToastService.ShowToast(response.Message);
            
            category = new();
            await deleteConfirmModal.Hide();
            currentPage = 1;
            await LoadCategories(currentPage);
        }
        catch (Exception ex)
        {
            throw new Exception(ex.Message);
        }
    }
}