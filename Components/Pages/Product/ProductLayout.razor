@page "/admin/products"
@using Blazor_FE.Services.Base
@using Blazor_FE.Services.Products.dtos
@using Microsoft.AspNetCore.WebUtilities
@using Blazorise.DataGrid
@inject IProductService ProductService
@inject NavigationManager NavigationManager

<div>
    @if (data == null)
    {
        <div>Loading...</div>
    }
    <button
        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
        @onclick="@(() => OpenModal("ADD"))">
        Add
    </button>
    <div class="flex-1 max-w-md flex gap-2">
        <input
            id="productName"
            @bind="searchQuery.ProductName"
            placeholder="Search products..."/>
        <button
            @onclick="HandleSearch"
            class="px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
            Search
        </button>
        <Slider TValue="decimal?"
                @bind-Value="searchQuery.MaxPrice"
                Min="10000"
                Max="3000000"
                Step="10000"
                ShowStepLabels="true" />
    </div>
    <DataGrid
        TItem="ProductDTO"
        Data="@(data?.Content ?? new())"
        PageSize="@pageSize"
        Sortable
        Responsive
        UseInternalEditing="false"
        @CurrentPage="currentPage">
        <DataGridColumns>
            @* ACTIONS *@
            <DataGridColumn Field="@nameof(ProductDTO.ProductId)" Caption="ID" Editable="false"></DataGridColumn>
            @* ACTIONS *@
            <DataGridColumn Field="@nameof(ProductDTO.ProductName)" Caption="Product Name"></DataGridColumn>
            @* ACTIONS *@
            <DataGridColumn Field="@nameof(ProductDTO.Price)" Caption="Price"></DataGridColumn>
            @* ACTIONS *@
            <DataGridColumn Field="@nameof(ProductDTO.Unit)" Caption="Unit"></DataGridColumn>
            @* ACTIONS *@
            <DataGridColumn Field="@nameof(ProductDTO.ProductImg)" Caption="Image">
                <DisplayTemplate>
                    @{
                        var url = context?.ProductImg;
                        if (!string.IsNullOrEmpty(url))
                        {
                            <img src="@url" style="height:50px;"/>
                        }
                        else
                        {
                            <span>No image</span>
                        }
                    }
                </DisplayTemplate>
            </DataGridColumn>
            @* ACTIONS *@
            <DataGridColumn Caption="Actions">
                <DisplayTemplate Context="context">
                    <div class="flex gap-2">
                        <button
                            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                            @onclick:preventDefault
                        >
                            View
                        </button>
                        <button
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                            @onclick:preventDefault
                            @onclick="@(() => OpenModal("EDIT", context))">
                            Edit
                        </button>
                        <button
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                            @onclick:preventDefault>
                            Delete
                        </button>
                    </div>
                </DisplayTemplate>
            </DataGridColumn>
            @* ADD MODAL *@
            @{
                var editProduct = selectedProduct;
            }
            <Modal @ref="@addModal">
                <ModalContent Size="ModalSize.Default" Class="p-4">
                    <div class="header-modal">
                        <CloseButton @onclick="@(() => CloseModal("ADD"))"/>
                        <ModalTitle>Add product</ModalTitle>
                    </div>
                    @* EDIT FORM *@
                    <EditForm Model="@newProduct" OnValidSubmit="handleAddProduct">
                        <Field>
                            <FieldLabel>Product Name</FieldLabel>
                            <InputText
                                Class="custom-input"
                                @bind-Value="newProduct.ProductName" 
                                placeholder="Product Name"
                            />
                        </Field>
                        <Field>
                            <FieldLabel>Barcode</FieldLabel>
                            <InputText 
                                Class="custom-input" 
                                @bind-Value="newProduct.Barcode" 
                                placeholder="Barcode"
                            />
                        </Field>
                        <Field>
                            <FieldLabel>Price</FieldLabel>
                            <InputNumber
                                TValue="decimal"
                                @bind-Value="newProduct.Price"
                                placeholder="Price"
                                Class="custom-input"
                            />
                        </Field>
                        <Field>
                            <FieldLabel>Unit</FieldLabel>
                            <InputText 
                                Class="custom-input" 
                                @bind-Value="newProduct.Unit" 
                                placeholder="Unit"
                            />
                        </Field>
                        <Field>
                            <FieldLabel>IMAGE</FieldLabel>
                            <InputFile
                                OnChange="OnImageChanged" 
                                accept="image/*"
                            />
                            <div class="mt-2">
                                <img
                                    class=""
                                    src="@imagePreviews.FirstOrDefault()"/>
                            </div>
                        </Field>
                        <Footer class="flex justify-end p-4 space-x-2">
                            <button
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                type="submit">
                                Save
                            </button>
                            <button
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                @onclick="@(() => CloseModal("ADD"))">
                                Cancel
                            </button>
                        </Footer>
                    </EditForm>
                </ModalContent>
            </Modal>
            @*  EDIT MODAL *@
            <Modal @ref="@editModal">
                <ModalContent Size="ModalSize.Default" Class="p-4">
                    <div class="header-modal">
                        <CloseButton @onclick="@(() => CloseModal("EDIT"))"/>
                        <ModalTitle>Edit</ModalTitle>
                    </div>
                    @* EDIT FORM *@
                    <EditForm Model="@editProduct" OnValidSubmit="handleEditProduct">
                        <Field>
                            <FieldLabel>Product Name</FieldLabel>
                            <TextEdit @bind-Text="@editProduct!.ProductName"/>
                        </Field>
                        <Field>
                            <FieldLabel>Price (VND)</FieldLabel>
                            <NumericEdit TValue="decimal" @bind-Value="editProduct!.Price"/>
                        </Field>
                        <Field>
                            <FieldLabel>Unit</FieldLabel>
                            <TextEdit @bind-Text="@editProduct!.Unit"/>
                        </Field>
                        <Field>
                            <FieldLabel>Image</FieldLabel>
                            @if (!string.IsNullOrEmpty(editProduct?.ProductImg))
                            {
                            <div class="mt-2">
                                <img src="@imagePreviews.FirstOrDefault()" alt="image" style="max-width: 200px; max-height: 200px;" class="mt-2" />
                            </div>
                            }
                        </Field>
                        <Footer class="flex justify-end p-4 space-x-2">
                            <button
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                type="submit">
                                Save
                            </button>
                            <button
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                @onclick="@(() => CloseModal("EDIT"))">
                                Cancel
                            </button>
                        </Footer>
                    </EditForm>
                </ModalContent>
            </Modal>
        </DataGridColumns>
    </DataGrid>
    <CustomPagination CurrentPage="@currentPage" TotalPages="@totalPages" OnPageChanged="OnPageChanged"></CustomPagination>
</div>

<style>
    .custom-input {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        width: 100%;
        transition: border-color 0.15s ease-in-out;
    }
    
    .custom-input:focus {
        border-color: transparent;
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        transition: box-shadow 0.2s ease-in-out;
    }
</style>

@code {
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages;
    private ProductDTO selectedProduct = new ();
    private APIResponse<List<ProductDTO>>? data;
    private Modal editModal = null!;
    private Modal addModal = null!;
    
    private ProductSearchDTO searchQuery = new ProductSearchDTO();
    
    private async Task HandleSearch()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        // var query = QueryHelpers.ParseQuery(uri.Query);
        var newQuery = new Dictionary<string, string>();
        
        // foreach (var item in query)
        // {
        //     if (item.Key != "productName") // We'll update this one
        //     {
        //         newQuery[item.Key] = item.Value.ToString();
        //     }
        // }
        
        if (!string.IsNullOrWhiteSpace(searchQuery.ProductName))
        {
            newQuery["productName"] = searchQuery.ProductName;
        }
        
        var newUri = QueryHelpers.AddQueryString(uri.GetLeftPart(UriPartial.Path), newQuery);
        NavigationManager.NavigateTo(newUri);
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData(currentPage);
    }

    private async Task LoadData(int page)
    {
        data = await ProductService.SearchProductPageAsync<ProductDTO>(page, pageSize);
        totalPages = data!.Metadata.TotalPages;
        StateHasChanged();
    }
    
    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadData(currentPage);
    }
    
    private void OpenModal(String type,ProductDTO? product = null)
    {
        switch (type)
        {
            case "ADD":
                addModal.Show();
                break;
            case "EDIT":
                selectedProduct = new ProductDTO
                {
                    ProductId = product.ProductId,
                    ProductName = product.ProductName,
                    Price = product.Price,
                    Barcode = product.Barcode,
                    Unit = product.Unit,
                    ProductImg = product.ProductImg,
                    SupplierId = product.SupplierId
                };
                editModal.Show();
                break;
        }
    }
    
    private void CloseModal(string type)
    {
        switch (type)
        {
            case "ADD":
                addModal.Hide();
                break;
            case "EDIT":
                editModal.Hide();
                break;
        }
    }
    
    private List<IBrowserFile> selectedFiles = new();
    private List<String> imagePreviews = new();
    private async Task OnImageChanged(InputFileChangeEventArgs e)
    {
        selectedFiles = e.GetMultipleFiles().ToList();
        imagePreviews.Clear();
        
        foreach (var file in selectedFiles)
        {
            using var stream = file.OpenReadStream();
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var imageBytes = memoryStream.ToArray();
            var imageBase64 = $"data:{file.ContentType};base64,{Convert.ToBase64String(imageBytes)}";
            imagePreviews.Add(imageBase64);
        }
    }
    
    @* HANDLE CRUD *@
    private ProductDTO newProduct = new ();
    private async Task handleAddProduct()
    {
        try
        {
            Console.WriteLine("Add");
        
            if (selectedFiles.Any())
            {
                var resUpload = await ProductService.UploadImage(selectedFiles.FirstOrDefault()!);
                if (resUpload.StatusCode != 200)
                {
                    throw new Exception(resUpload.Message);
                }

                newProduct.ProductImg = resUpload.Content;
            }

            if (String.IsNullOrEmpty(newProduct.ProductImg))
            {
                Console.WriteLine("No image");
            }
            
            var response = await ProductService.AddProduct(newProduct);
            
            if (response.StatusCode != 200)
            {
                throw new Exception(response.Message);
            }
            
            newProduct = new();
            selectedFiles.Clear();
            imagePreviews.Clear();
            await addModal.Hide();
            await LoadData(totalPages);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding product: {ex.Message}");
            throw; 
        }
    }
    
    private async Task handleEditProduct()
    {
        try
        {
            if (selectedProduct == null) return;

            var request = new ProductDTO
            {
                ProductName = selectedProduct.ProductName,
                Price = selectedProduct.Price,
                Barcode = selectedProduct.Barcode!,
                Unit = selectedProduct.Unit!,
                ProductImg = selectedProduct.ProductImg,
                SupplierId = selectedProduct.SupplierId
            };

            var response = await ProductService.EditProduct(selectedProduct.ProductId, request);

            if (response.StatusCode != 200)
            {
                throw new Exception(response.Message);
            }
            
            await editModal.Hide();
            await LoadData(currentPage); 
        }
        catch (Exception e)
        {
            throw new Exception(e.Message);
        }
    }
}